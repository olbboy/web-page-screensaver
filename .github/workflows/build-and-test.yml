name: Build and Test

on:
  push:
    branches: [ main, master, develop, 'claude/**' ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

env:
  DOTNET_VERSION: '8.0.x'
  CONFIGURATION: Release

jobs:
  build:
    name: Build on Windows
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for better analysis

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Display .NET info
      run: dotnet --info

    - name: Restore dependencies
      run: dotnet restore

    - name: Build solution
      run: dotnet build --configuration ${{ env.CONFIGURATION }} --no-restore

    - name: Verify .scr file generation
      run: |
        $scrFile = "bin\Release\net8.0-windows\Web-Page-Screensaver.scr"
        if (Test-Path $scrFile) {
          Write-Host "âœ… Screensaver file generated successfully: $scrFile"
          $fileInfo = Get-Item $scrFile
          Write-Host "   Size: $($fileInfo.Length) bytes"
          Write-Host "   Modified: $($fileInfo.LastWriteTime)"
        } else {
          Write-Host "âŒ Screensaver file not found!"
          exit 1
        }
      shell: pwsh

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: screensaver-build
        path: |
          bin/Release/net8.0-windows/*.scr
          bin/Release/net8.0-windows/*.exe
          bin/Release/net8.0-windows/*.dll
          bin/Release/net8.0-windows/*.pdb
        retention-days: 30

  code-quality:
    name: Code Quality Analysis
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore dependencies
      run: dotnet restore

    - name: Build with analyzers
      run: dotnet build --configuration Debug --no-restore /p:TreatWarningsAsErrors=false

    - name: Check code formatting
      run: dotnet format --verify-no-changes --verbosity diagnostic
      continue-on-error: true

  security-scan:
    name: Security Vulnerability Scan
    runs-on: windows-latest
    permissions:
      security-events: write
      contents: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore dependencies
      run: dotnet restore

    - name: Run security scan
      run: |
        dotnet list package --vulnerable --include-transitive 2>&1 | Tee-Object -Variable output
        if ($output -match "has the following vulnerable packages") {
          Write-Host "âš ï¸ Vulnerable packages detected!"
          exit 1
        } else {
          Write-Host "âœ… No vulnerable packages detected"
        }
      shell: pwsh
      continue-on-error: true

  dependency-check:
    name: Dependency Analysis
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: List all dependencies
      run: |
        Write-Host "ğŸ“¦ Project Dependencies:"
        dotnet list package --include-transitive

        Write-Host "`nğŸ“Š Dependency Tree:"
        dotnet list package --include-transitive --format json | ConvertFrom-Json | ConvertTo-Json -Depth 10
      shell: pwsh

  release-notes:
    name: Generate Release Notes
    runs-on: windows-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    needs: [build, code-quality]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Generate changelog
      run: |
        Write-Host "ğŸ“ Recent Commits:"
        git log --pretty=format:"%h - %s (%an, %ar)" -10
      shell: pwsh

  summary:
    name: Build Summary
    runs-on: windows-latest
    needs: [build, code-quality, security-scan, dependency-check]
    if: always()

    steps:
    - name: Build Summary
      run: |
        Write-Host "================================"
        Write-Host "ğŸ¯ Build Summary"
        Write-Host "================================"
        Write-Host "Build Status: ${{ needs.build.result }}"
        Write-Host "Code Quality: ${{ needs.code-quality.result }}"
        Write-Host "Security Scan: ${{ needs.security-scan.result }}"
        Write-Host "Dependencies: ${{ needs.dependency-check.result }}"
        Write-Host "================================"

        if ("${{ needs.build.result }}" -eq "success") {
          Write-Host "âœ… Build completed successfully!"
          exit 0
        } else {
          Write-Host "âŒ Build failed!"
          exit 1
        }
      shell: pwsh
